<!DOCTYPE html>
<html class="loading" lang="en" data-textdirection="ltr">
	<head>
		<link rel="stylesheet" type="text/css" href="./theme-assets/css/bootstrap.min.css">
		<%- include('../partials/head'); %>
		<!-- END Three.js Load -->
		<style>
			#terminal{
				max-height: 200px;
				overflow-y: scroll;
			}
			button.btn-min-width{
				width: 130px;
				padding: 0.75rem !important;
				margin: 5px !important;
				/* text-align: left !important; */
			}
			.content{
				min-height: auto !important;
			}
			footer.footer{
				position: fixed;
				bottom: 0%;
				width: calc(100% - 260px);
			}
			@media (max-width: 768px){
				footer.footer{
					width: 100%;
				}
			}
			#mini{
				/* float: right; */
				position: fixed;
				bottom: 8px;
				right: 30px;
			}
			button.close:focus{
				outline: none;
			}
			.alert{
				width: calc(100% - 10px);
				padding: 0.5rem 1.25rem;
				margin-bottom: 0.5rem;
			}
			.alert .close{
				line-height: 0rem;
			}
			th,td{
				vertical-align: middle !important;
			}
			thead{
				background-color: #28afd0;
				color: white;
			}
			.table-responsive{
				border-radius: 10px;
			}
		</style>
	</head>
	<body class="vertical-layout vertical-menu 2-columns   menu-expanded fixed-navbar" data-open="click" data-menu="vertical-menu" data-color="bg-gradient-x-purple-blue" data-col="2-columns">
		<!-- fixed-top-->
		<%- include('../partials/header'); %>
		<!-- ////////////////////////////////////////////////////////////////////////////-->
		<%- include('../partials/sidebar'); %>
		
		<!-- dashboard -->
		<div class="app-content content">
			<div class="content-wrapper">
				<div class="content-wrapper-before"></div>
				<div class="content-header row">
					<div class="content-header-left col-md-4 col-12 mb-2">
						<h3 class="content-header-title">Control Center</h3>
					</div>
					<div class="content-header-right col-md-8 col-12">
						<div class="breadcrumbs-top float-md-right">
							<div class="breadcrumb-wrapper mr-1">
								<ol class="breadcrumb">
									<li class="breadcrumb-item"><a href="/">Home</a>
									</li>
									<li class="breadcrumb-item active">Control Center
									</li>
								</ol>
							</div>
						</div>
					</div>
				</div>
				
				<div class="content-body">
					<section id="basic-buttons">
					<!-- 3d viewer card body start -->
						<div class="row">
							<div class="col-lg-12 col-md-12">
								<div class="card" id="canvas-container">
									<div class="card-header">
										<a class="heading-elements-toggle"><i class="la la-ellipsis font-medium-3"></i></a>
										<div class="heading-elements">
											<a data-action="expand"><i class="ft-maximize"></i></a>
										</div>
									</div>
									<div class="card-content collapse show"  style="position: relative;">
										<div class="card-body">
											<h2>Socket Status : <span style="font-size: smaller;" id="status"></span></h2><br>
											<fieldset class="close_field">
												<legend class="close_field">Socket Control</legend>
												<button type="button" onclick="initWebSocket()" id="connect" class="btn btn-custom-line"><i class="ft-wifi"></i> Connect</button>
												<button type="button" onclick="scan()" id="start_scan" class="btn btn-custom-line"><i class="ft-eye"></i> Scan</button>
												<button type="button" onclick="stopWebSocket()" id="disconnect" class="btn btn-custom-line"><i class="ft-wifi-off"></i> Disconnect</button>
											</fieldset>

											<fieldset class="close_field">
												<legend class="close_field">APP Control</legend>
												<div class="row">
													<div class="col-md-6 col-12">
														<div class="input-group" style="margin: 5px;">
															<input type="text" id="filepath" class="form-control" value="<%= path%>" placeholder="*.exe File path" aria-label="Recipient's username" aria-describedby="basic-addon2">
															<div class="input-group-append">
																<span class="input-group-text" style="cursor: pointer;">PATH</span>
															</div>
														</div>
													</div>
													<div class="col-md-6 col-12">
														<button type="button" onclick="runApp()" id="run" class="btn btn-custom-fill"><i class="ft-sun"></i> Run</button>
														<button type="button" onclick="killApp()" id="kill" class="btn btn-custom-fill"><i class="ft-alert-triangle"></i> Kill</button>
													</div>
												</div>
											</fieldset>
											<fieldset class="close_field">
												<legend class="close_field">Schedule</legend>
												<div class="table-responsive">
													<table class="table table-striped table-hover table-border">
														<thead>
															<tr>
																<th>Day</th>
																<th>Interval Value</th>
																<th>Interval Unit</th>
																<th>Start time</th>
																<th>End time</th>
																<th style="text-align: center;" onclick="openTable()"><i class="la la-angle-up"></i></th>
															</tr>
														</thead>
														<tbody>
															<% for(var i=0; i<schedule_data.length; i++) {%>
																<tr id="<%=schedule_data[i].day%>">
																	<td><%=schedule_data[i].day%></td>
																	<td><%=schedule_data[i].interval_value%></td>
																	<td><%=schedule_data[i].unit%></td>
																	<td><%=schedule_data[i].start_time%></td>
																	<td><%=schedule_data[i].end_time%></td>
																	<td style="text-align: center;">
																		<button class="btn btn-info" style="padding: 0.5rem;" onclick="openModal('<%=JSON.stringify(schedule_data[i])%>')">
																			<i class="la la-pencil"></i>
																		</button>
																	</td>
																</tr>
																<%}%>
														</tbody>
													</table>
												</div>
											</fieldset>
											<!-- <div>
												<img src="/img/loading.gif" id="loadingimg" style="position: absolute;top: 0px;right: 0;left: 0;margin: 0 auto; z-index: 100;">
											</div>	 -->
										</div>
									</div>
								</div>
							</div>
						</div>
					</section>
				</div>


			</div>
		</div>
<!-- ////////////////////////////////////////////////////////////////////////////-->
		<!-- Modal -->
		<div class="modal fade" id="dayModal" role="dialog" style="z-index: 1052;">
			<div class="modal-dialog modal-lg">
				<div class="modal-content">
					<div class="modal-header">
						<h4 class="modal-title" id="day">Modal Header</h4>
						<button type="button" class="close" data-dismiss="modal">&times;</button>
					</div>
					<div class="modal-body">
						<div class="row">
							<div class="col-lg-3 col-md-6 col-6">
								<div class="input-group" style="margin: 5px;">
									<div class="input-group-prepend">
										<span class="input-group-text" style="cursor: pointer;">Value</span>
									</div>
									<input type="text" id="interval_value" class="form-control" value="1" aria-label="Recipient's username" aria-describedby="basic-addon2">
								</div>
							</div>
							<div class="col-lg-3 col-md-6 col-6">
								<div class="input-group" style="margin: 5px;">
									<div class="input-group-prepend">
									 	<label class="input-group-text" for="unit">Unit</label>
									</div>
									<select class="custom-select" id="unit">
										<option value="hr" selected>hr</option>
									  	<option value="min">min</option>
									</select>
								</div>
							</div>
							<div class="col-lg-3 col-md-6 col-6">
								<div class="input-group" style="margin: 5px;">
									<div class="input-group-prepend">
									 	<label class="input-group-text" for="start_time">Start</label>
									</div>
									<input type="text" id="start_time" class="form-control" value="1" placeholder="HH:mm" aria-label="Recipient's username" aria-describedby="basic-addon2">

									<!-- <select class="custom-select" id="start_time">
										  <% for(var i=0; i<25; i++) {%>
											<option value="<%=i%>"><%=i%></option>
										<%}%>
									</select> -->
								</div>
							</div>
							<div class="col-lg-3 col-md-6 col-6">
								<div class="input-group" style="margin: 5px;">
									<div class="input-group-prepend">
									 	<label class="input-group-text" for="end_time">End</label>
									</div>
									<input type="text" id="end_time" class="form-control" value="1" placeholder="HH:mm" aria-label="Recipient's username" aria-describedby="basic-addon2">

									<!-- <select class="custom-select" id="end_time">
										<% for(var i=0; i<25; i++) {%>
										  <option value="<%=i%>"><%=i%></option>
									  <%}%>
									</select> -->
								</div>
							</div>
						</div>
					</div>
					<div class="modal-footer" style="justify-content: center;">
						<button type="button" class="btn btn-info" id="save_sch">Save</button>
					</div>
				</div>
			</div>
		</div>
<!-- /////////////////////////////////////////////////////////////////////////// -->
		<footer class="footer footer-light navbar-border navbar-shadow">
			<div id="terminal">

			</div>
			<div class="clearfix blue-grey lighten-2 text-sm-center mb-0 px-2">
				<span class="float-md-left d-block d-md-inline-block">2021  &copy; Copyright 
					<a class="text-bold-800 grey darken-2" href="https://themeselection.com" target="_blank"> &nbsp;Quirin Kraus</a>
				</span>
				<span id="mini" onclick="openTerminal()"><i class="la la-angle-up"></i></span>
			</div>
		</footer>
		<script src="./theme-assets/js/core/libraries/bootstrap.min.js"></script>
		<script src="./theme-assets/vendors/js/forms/toggle/switchery.min.js"></script>
		<script src="./theme-assets/js/scripts/forms/switch.min.js"></script>
		<script src="./theme-assets/vendors/js/forms/tags/form-field.js"></script>

		<!-- BEGIN: Vendor JS-->
		<!-- <script src="./theme-assets/js/core/app-menu.min.js" type="text/javascript"></script>
		<script src="./theme-assets/js/core/app.min.js" type="text/javascript"></script> -->
		<script src="./theme-assets/js/scripts/customizer.min.js" type="text/javascript"></script>
		<script src="./theme-assets/vendors/js/jquery.sharrre.js" type="text/javascript"></script>
		<!-- END: Theme JS -->
		<!-- page content end -->
		<script>
			var server_ip = <%- JSON.stringify(server_ip) %>; 
		</script>
		<script type="text/javascript">
			$(document).ready(()=>{
				initWebSocket();
				$('#terminal').hide();
			});
			let socket_state;
			let terminal = false;
			let expandTable = true;
			/******************************  app  section  ******************/
			/*
				run app along path
			*/
			function runApp(){
				let param = {path:$('#filepath').val()};
				$.post( '/control/runApp', param, function( result ) {
					if(result === 'success')
						showMessage('success','OPEN APP', "Open Successfully.");
					else
						showMessage('error', 'OPEN APP', "Input correct *.exe file path");

				});
			}
			/*
				kill app
			*/
			function killApp(){
				let param = [];
				$.post( '/control/killApp', param, function( result ) {
					if(result === 'success')
						showMessage('success','Close APP', "Closed Successfully.");
					else
						showMessage('warning', 'Close APP', "There isn't opened App");
				});
			}
			/******************************  socket  section  ******************/
			/*
				scan pointcloud if socket live
			*/
			function scan(){
				var state = checkSocket();
				if(state === 1){
					sendMessage("start scan");
				}else{
					showMessage('warning','SOCKET', 'Socket disconnected');
				}
			}
			/*
				message show
			*/
			function showMessage(status,head,text){
				$.toast({
					heading: head,
					text: text,
					showHideTransition: 'fade',
					icon: status,
					hideAfter: 5000   // in milli seconds
				});
			}
			/*
				send data to socket server and receive message from websocket server.
			*/
			function sendMessage(msg) {
			if ( websocket != null )
				{
					websocket.send( msg );
					console.log( "string sent :", '"'+msg+'"' );
				}
			}
			
			var wsUri = "ws://" + server_ip + ":1234";
			var websocket = null;
			/*
				link socket server.
			*/
			function initWebSocket() {
				try {
					if (typeof MozWebSocket == 'function')
						WebSocket = MozWebSocket;
					if ( websocket && websocket.readyState == 1 ){
						showMessage('success','STATUS', 'Socket is already connected');
						return;
					}
					websocket = new WebSocket( wsUri );
					websocket.onopen = function (evt) {
						setStatus('Connected');
						showMessage('success','SOCKET', 'Socket connected');
					};
					websocket.onclose = function (evt) {
						setStatus('Disconnected');
						showMessage('warning','SOCKET', 'Socket disconnected');
					};
					websocket.onmessage = function (evt) {
						setStatus('Scan');
						showMessage('info','MESSAGE', evt.data);
					};
					websocket.onerror = function (evt) {
						showMessage('error','SOCKET', 'FAILED');
					};
				} catch (exception) {
					showMessage('error','SOCKET', 'FAILED');
				}
			}
			/*
				disconnect socket server.
			*/
			function stopWebSocket() {
				if (websocket){
					websocket.close();
					showMessage('success','STATUS', 'Disconnect successfully');
				}else{
					showMessage('warning','STATUS', 'Socket is already disconnected');
				}
			}
			/*
				display status message
			*/
			function checkSocket_message(status){
				switch(status){
					case 0: {
						showMessage('success','STATUS', 'Socket connecting');
						break;
					}
					case 1: {
						showMessage('success','STATUS', 'Socket open');
						break;
					}
					case 2: {
						showMessage('warning','STATUS', 'Socket closing');
						break;
					}
					case 3: {
						showMessage('warning','STATUS', 'Socket closed');
						break;
					}
					default: {
						showMessage('error','STATUS', 'UNKNOW');
						break;
					}
				}
			}
			/*
				check socket status
			*/
			function checkSocket() {
				if (websocket != null) {
					return websocket.readyState;
				} else {
					showMessage('error','SOCKET', 'FAILED');
					return 'no';
				}
			}
			/*
				set socket status
			*/
			var objTerminal = document.getElementById("terminal");
			function setStatus(status){
				var today = new Date();
				var date = today.getFullYear()+'-'+(today.getMonth()+1)+'-'+today.getDate();
				var time = today.getHours() + ":" + today.getMinutes() + ":" + today.getSeconds();
				var dateTime = date+' '+time;
				switch(status){
					case 'Connected':
						if(socket_state === 'connect') return;
						socket_state = 'connect';
						var str = 'Connected ( ' + dateTime + ' )';
						$('#status').html(str).css('color','green');
						$('#terminal').append('<div class="alert alert-success alert-dismissible fade show" role="alert"><strong>' + str + '</strong><button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button></div>');
						break;
					case 'Disconnected':
						if(socket_state === 'disconnect') return;
						socket_state = 'disconnect';
						var str = 'Disconnected ( ' + dateTime + ' )';
						$('#status').html(str).css('color','red');
						$('#terminal').append('<div class="alert alert-danger alert-dismissible fade show" role="alert"><strong>' + str + '</strong><button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button></div>');
						break;
					case 'Scan':
						var str = 'Scan successfully ( ' + dateTime + ' )';
						$('#terminal').append('<div class="alert alert-info alert-dismissible fade show" role="alert"><strong>' + str + '</strong><button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button></div>');
						break;
					default:
						break;
					}
				objTerminal.scrollTop = objTerminal.scrollHeight;
			}
			/******************************  Terminal  ***********************/
			function openTerminal(){
				terminal = !terminal;
				if(terminal){
					$('#terminal').fadeIn();
					$('.la.la-angle-up').removeClass('la-angle-up').addClass('la-angle-down');
					objTerminal.scrollTop = objTerminal.scrollHeight;
				}else{
					$('#terminal').fadeOut();
					$('.la.la-angle-down').removeClass('la-angle-down').addClass('la-angle-up');
				}
			}
			function openTable(){
				expandTable = !expandTable;
				if(expandTable){
					$('tbody').fadeIn();
					$('.la.la-angle-down').removeClass('la-angle-down').addClass('la-angle-up');
				}else{
					$('tbody').fadeOut();
					$('.la.la-angle-up').removeClass('la-angle-up').addClass('la-angle-down');
				}
			}
			function openModal(day){
				let object = JSON.parse(day);
				console.log(object)
				$('#dayModal').modal('show');
				$('#interval_value').val(object.interval_value);
				if(object.unit === '')
					$('#unit').val('hr');
				else
					$('#unit').val(object.unit);
				$('#start_time').val(object.start_time);
				$('#end_time').val(object.end_time);
				$('#day').html(object.day);
			}
			$('#save_sch').click((e)=>{
				let param = {
					day:$('#day').html(),
					interval_value:$('#interval_value').val(),
					unit:$('#unit').val(),
					start_time:$('#start_time').val(),
					end_time:$('#end_time').val(),
				}
				var start_arr = param.start_time.split(':');
				if(start_arr[0]*1>24||start_arr[1]*1>60||start_arr[0]*1<0||start_arr[1]*1<0||(start_arr[0]*1 === 23&&start_arr[1]*1>59)){
					showMessage('error','ERROR','Input correct value');
					$('#start_time').focus();
					return;
				}
				var end_err = param.end_time.split(':');
				if(end_err[0]*1>23||end_err[1]*1>60||end_err[0]*1<0||end_err[1]*1<0||(end_err[0]*1 === 23&&end_err[1]*1>59)){
					showMessage('error','ERROR','Input correct value');
					$('#end_time').focus();
					return;
				}
				if(!(end_err[0]*1>start_arr[0]*1||end_err[0]*1 == start_arr[0]*1&&end_err[1]*1>=start_arr[1]*1)){
					showMessage('error','ERROR',"Start time can't set after end time");
					return;
				}
				$.post( '/control/save_sch', param, function( result ) {
					if(result === 'success'){
						$('#' + param.day + ' td:nth-child(2)').html(param.interval_value);
						$('#' + param.day + ' td:nth-child(3)').html(param.unit);
						$('#' + param.day + ' td:nth-child(4)').html(param.start_time);
						$('#' + param.day + ' td:nth-child(5)').html(param.end_time);
						$('#' + param.day + ' td:nth-child(6) button').attr('onclick','openModal(\''+JSON.stringify(param)+'\')');
						showMessage('success','SCHEDULE', "Saved Successfully.");
						$('#dayModal').modal('hide');
					}
					else{
						showMessage('error', 'SCHEDULE', "Failed");
					}

				});
			})
		</script>
	</body>
</html>