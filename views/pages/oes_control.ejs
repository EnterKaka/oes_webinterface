<!DOCTYPE html>
<html class="loading" lang="en" data-textdirection="ltr">
	<head>
		<link rel="stylesheet" type="text/css" href="./theme-assets/css/bootstrap.min.css">
		<%- include('../partials/head'); %>
		<!-- END Three.js Load -->
		<style>
			#terminal{
				max-height: 200px;
				overflow-y: scroll;
			}
			button.btn-min-width{
				width: 130px;
				padding: 0.75rem !important;
				margin: 5px !important;
				/* text-align: left !important; */
			}
			.content{
				min-height: auto !important;
			}
			footer.footer{
				position: fixed;
				bottom: 0%;
				width: calc(100% - 260px);
			}
			#mini{
				float: right;
			}
			button.close:focus{
				outline: none;
			}
			.alert{
				width: calc(100% - 10px);
				padding: 0.5rem 1.25rem;
				margin-bottom: 0.5rem;
			}
			.alert .close{
				line-height: 0rem;
			}
		</style>
	</head>
	<body class="vertical-layout vertical-menu 2-columns   menu-expanded fixed-navbar" data-open="click" data-menu="vertical-menu" data-color="bg-gradient-x-purple-blue" data-col="2-columns">
		<!-- fixed-top-->
		<%- include('../partials/header'); %>
		<!-- ////////////////////////////////////////////////////////////////////////////-->
		<%- include('../partials/sidebar'); %>
		
		<!-- dashboard -->
		<div class="app-content content">
			<div class="content-wrapper">
				<div class="content-wrapper-before"></div>
				<div class="content-header row">
					<div class="content-header-left col-md-4 col-12 mb-2">
						<h3 class="content-header-title">Control Center</h3>
					</div>
					<div class="content-header-right col-md-8 col-12">
						<div class="breadcrumbs-top float-md-right">
							<div class="breadcrumb-wrapper mr-1">
								<ol class="breadcrumb">
									<li class="breadcrumb-item"><a href="/">Home</a>
									</li>
									<li class="breadcrumb-item active">Control Center
									</li>
								</ol>
							</div>
						</div>
					</div>
				</div>
				
				<div class="content-body">
					<section id="basic-buttons">
					<!-- 3d viewer card body start -->
						<div class="row">
							<div class="col-lg-12 col-md-12">
								<div class="card" id="canvas-container">
									<div class="card-header">
										<a class="heading-elements-toggle"><i class="la la-ellipsis font-medium-3"></i></a>
										<div class="heading-elements">
											<a data-action="expand"><i class="ft-maximize"></i></a>
										</div>
									</div>
									<div class="card-content collapse show"  style="position: relative;">
										<div class="card-body">
											<h2>Socket Status : <span style="font-size: smaller;" id="status"></span></h2><br>
											<fieldset class="close_field">
												<legend class="close_field">Socket Control</legend>
												<button type="button" onclick="initWebSocket()" id="connect" class="btn btn-info btn-min-width"><i class="ft-wifi"></i> Connect</button>
												<button type="button" onclick="scan()" id="start_scan" class="btn btn-info btn-min-width"><i class="ft-eye"></i> Scan</button>
												<button type="button" onclick="stopWebSocket()" id="disconnect" class="btn btn-info btn-min-width"><i class="ft-wifi-off"></i> Disconnect</button>
											</fieldset>

											<fieldset class="close_field">
												<legend class="close_field">APP Control</legend>
												<div class="row">
													<div class="col-md-6 col-12">
														<div class="input-group" style="margin: 5px;">
															<input type="text" id="filepath" class="form-control" value="<%= path%>" placeholder="*.exe File path" aria-label="Recipient's username" aria-describedby="basic-addon2">
															<div class="input-group-append">
																<span class="input-group-text" style="cursor: pointer;">PATH</span>
															</div>
														</div>
													</div>
													<div class="col-md-6 col-12">
														<button type="button" onclick="runApp()" id="run" class="btn btn-info btn-min-width"><i class="ft-sun"></i> Run</button>
														<button type="button" onclick="killApp()" id="kill" class="btn btn-info btn-min-width"><i class="ft-alert-triangle"></i> Kill</button>
													</div>
												</div>
											</fieldset>
											<!-- <div>
												<img src="/img/loading.gif" id="loadingimg" style="position: absolute;top: 0px;right: 0;left: 0;margin: 0 auto; z-index: 100;">
											</div>	 -->
										</div>
									</div>
								</div>
							</div>
						</div>
					</section>
				</div>


			</div>
		</div>
<!-- ////////////////////////////////////////////////////////////////////////////-->

<footer class="footer footer-light navbar-border navbar-shadow">
	<div id="terminal">

	</div>
    <div class="clearfix blue-grey lighten-2 text-sm-center mb-0 px-2">
      <span class="float-md-left d-block d-md-inline-block">2021  &copy; Copyright 
        <a class="text-bold-800 grey darken-2" href="https://themeselection.com" target="_blank"> &nbsp;Quirin Kraus</a>
      </span>
	  <span id="mini" onclick="openTerminal()"><i class="la la-angle-up"></i></span>
    </div>
  </footer>
  <script src="./theme-assets/js/core/libraries/bootstrap.min.js"></script>
  <script src="./theme-assets/vendors/js/forms/toggle/switchery.min.js"></script>
  <script src="./theme-assets/js/scripts/forms/switch.min.js"></script>
  <script src="./theme-assets/vendors/js/forms/tags/form-field.js"></script>
  
  <!-- BEGIN: Vendor JS-->
  <!-- <script src="./theme-assets/js/core/app-menu.min.js" type="text/javascript"></script>
  <script src="./theme-assets/js/core/app.min.js" type="text/javascript"></script> -->
  <script src="./theme-assets/js/scripts/customizer.min.js" type="text/javascript"></script>
  <script src="./theme-assets/vendors/js/jquery.sharrre.js" type="text/javascript"></script>
  <!-- END: Theme JS -->
<!-- page content end -->
<script>
	var server_ip = <%- JSON.stringify(server_ip) %>; 
</script>
<script type="text/javascript">
	$(document).ready(()=>{
		initWebSocket();
		$('#terminal').hide();
	});
	let socket_state;
	let terminal = false;
	/*
		run app along path
	*/
	function runApp(){
		let param = {path:$('#filepath').val()};
		$.post( '/control/runApp', param, function( result ) {
			if(result === 'success')
				showMessage('success','OPEN APP', "Open Successfully.");
			else
				showMessage('error', 'OPEN APP', "Input correct *.exe file path");

		});
	}
	/*
		kill app
	*/
	function killApp(){
		let param = [];
		$.post( '/control/killApp', param, function( result ) {
			if(result === 'success')
				showMessage('success','Close APP', "Closed Successfully.");
			else
				showMessage('warning', 'Close APP', "There isn't opened App");
		});
	}
	/*
		scan pointcloud if socket live
	*/
	function scan(){
		var state = checkSocket();
		if(state === 1){
			sendMessage("start scan");
		}else{
			showMessage('warning','SOCKET', 'Socket disconnected');
		}
	}
	/*
		message show
	*/
	function showMessage(status,head,text){
		$.toast({
			heading: head,
			text: text,
			showHideTransition: 'fade',
			icon: status,
			hideAfter: 5000   // in milli seconds
		});
	}
	/*
		send data to socket server and receive message from websocket server.
	*/
	function sendMessage(msg) {
	if ( websocket != null )
		{
			websocket.send( msg );
			console.log( "string sent :", '"'+msg+'"' );
		}
	}
	
	var wsUri = "ws://" + server_ip + ":1234";
	var websocket = null;
	/*
		link socket server.
	*/
	function initWebSocket() {
		try {
			if (typeof MozWebSocket == 'function')
				WebSocket = MozWebSocket;
			if ( websocket && websocket.readyState == 1 ){
				showMessage('success','STATUS', 'Socket is already connected');
				return;
			}
			websocket = new WebSocket( wsUri );
			websocket.onopen = function (evt) {
				setStatus('Connected');
				showMessage('success','SOCKET', 'Socket connected');
			};
			websocket.onclose = function (evt) {
				setStatus('Disconnected');
				showMessage('warning','SOCKET', 'Socket disconnected');
			};
			websocket.onmessage = function (evt) {
				setStatus('Scan');
				showMessage('info','MESSAGE', evt.data);
			};
			websocket.onerror = function (evt) {
				showMessage('error','SOCKET', 'FAILED');
			};
		} catch (exception) {
			showMessage('error','SOCKET', 'FAILED');
		}
	}
	/*
		disconnect socket server.
	*/
	function stopWebSocket() {
		if (websocket){
			websocket.close();
			showMessage('success','STATUS', 'Disconnect successfully');
		}else{
			showMessage('warning','STATUS', 'Socket is already disconnected');
		}
	}
	/*
		display status message
	*/
	function checkSocket_message(status){
		switch(status){
			case 0: {
				showMessage('success','STATUS', 'Socket connecting');
				break;
			}
			case 1: {
				showMessage('success','STATUS', 'Socket open');
				break;
			}
			case 2: {
				showMessage('warning','STATUS', 'Socket closing');
				break;
			}
			case 3: {
				showMessage('warning','STATUS', 'Socket closed');
				break;
			}
			default: {
				showMessage('error','STATUS', 'UNKNOW');
				break;
			}
		}
	}
	/*
		check socket status
	*/
	function checkSocket() {
		if (websocket != null) {
			return websocket.readyState;
		} else {
			showMessage('error','SOCKET', 'FAILED');
			return 'no';
		}
	}
	/*
		set socket status
	*/
	function setStatus(status){
		var today = new Date();
		var date = today.getFullYear()+'-'+(today.getMonth()+1)+'-'+today.getDate();
		var time = today.getHours() + ":" + today.getMinutes() + ":" + today.getSeconds();
		var dateTime = date+' '+time;
		switch(status){
			case 'Connected':
				if(socket_state === 'connect') return;
				socket_state = 'connect';
				var str = 'Connected ( ' + dateTime + ' )';
				$('#status').html(str).css('color','green');
				$('#terminal').append('<div class="alert alert-success alert-dismissible fade show" role="alert"><strong>' + str + '</strong><button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button></div>');
				break;
			case 'Disconnected':
				if(socket_state === 'disconnect') return;
				socket_state = 'disconnect';
				var str = 'Disconnected ( ' + dateTime + ' )';
				$('#status').html(str).css('color','red');
				$('#terminal').append('<div class="alert alert-danger alert-dismissible fade show" role="alert"><strong>' + str + '</strong><button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button></div>');
				break;
			case 'Scan':
				var str = 'Scan successfully ( ' + dateTime + ' )';
				$('#terminal').append('<div class="alert alert-info alert-dismissible fade show" role="alert"><strong>' + str + '</strong><button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button></div>');
				break;
			default:
				break;
		}
	}
	function openTerminal(){
		terminal = !terminal;
		if(terminal){
			$('#terminal').show();
			$('.la.la-angle-up').removeClass('la-angle-up').addClass('la-angle-down');
			var objDiv = document.getElementById("terminal");
			objDiv.scrollTop = objDiv.scrollHeight;
		}else{
			$('#terminal').hide();
			$('.la.la-angle-down').removeClass('la-angle-down').addClass('la-angle-up');
		}
	}
</script>
</body>
</html>